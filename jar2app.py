#!/usr/bin/env python
# -*- coding: utf-8 -*-
##
## Copyright (C) 2015-2018 João Ricardo Lourenço <jorl17.8@gmail.com>
##
## Github: https://github.com/Jorl17
##
## Project main repository: https://github.com/Jorl17/jar2app
##
## This file is part of jar2app.
##
## jar2app is free software: you can redistribute it and/or modify
## it under the terms of the GNU General Public License as published by
## the Free Software Foundation, either version 2 of the License, or
## (at your option) any later version.
##
## jar2app is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with jar2app.  If not, see <http://www.gnu.org/licenses/>.
##
from optparse import OptionParser
import os.path
import shutil
import tempfile
from zipfile import ZipFile
import sys
import shlex

__author__ = 'jorl17'
VERSION = '1.0.1'

# Python 2 compatibility
is_python2 = sys.version_info[0] == 2
if is_python2:
    FileExistsError = OSError



#------------------------------------------------------------------------------
# Defaults
#------------------------------------------------------------------------------
DEFAULT_VERSION='1.0.1'
DEFAULT_BUNDLE_IDENTIFIER_PREFIX='com.jar2app.example.'
DEFAULT_SIGNATURE='????'
DEFAULT_EXECUTABLE_NAME='JavaAppLauncher'

#------------------------------------------------------------------------------
# The JavaAppLauncher file represented as a hex string
#------------------------------------------------------------------------------
java_app_launcher='CFFAEDFE07000001030000800200000012000000000A0000850020000000000019000000480000005F5F504147455A45524F00000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000019000000780200005F5F54455854000000000000000000000000000001000000003000000000000000000000000000000030000000000000070000000500000007000000000000005F5F74657874000000000000000000005F5F54455854000000000000000000009010000001000000B61900000000000090100000040000000000000000000000000400800000000000000000000000005F5F73747562730000000000000000005F5F5445585400000000000000000000462A0000010000004800000000000000462A0000010000000000000000000000080400800000000006000000000000005F5F737475625F68656C7065720000005F5F5445585400000000000000000000902A0000010000008800000000000000902A0000020000000000000000000000000400800000000000000000000000005F5F6763635F6578636570745F7461625F5F5445585400000000000000000000182B0000010000006000000000000000182B0000020000000000000000000000000000000000000000000000000000005F5F63737472696E67000000000000005F5F5445585400000000000000000000782B0000010000008303000000000000782B0000030000000000000000000000020000000000000000000000000000005F5F756E77696E645F696E666F0000005F5F5445585400000000000000000000FB2E0000010000006800000000000000FB2E0000000000000000000000000000000000000000000000000000000000005F5F65685F6672616D650000000000005F5F5445585400000000000000000000682F0000010000009000000000000000682F00000300000000000000000000000000000000000000000000000000000019000000680300005F5F4441544100000000000000000000003000000100000000100000000000000030000000000000001000000000000007000000030000000A000000000000005F5F70726F6772616D5F7661727300005F5F44415441000000000000000000000030000001000000280000000000000000300000040000000000000000000000000000000000000000000000000000005F5F6E6C5F73796D626F6C5F707472005F5F44415441000000000000000000002830000001000000100000000000000028300000030000000000000000000000060000000C00000000000000000000005F5F676F7400000000000000000000005F5F44415441000000000000000000003830000001000000180000000000000038300000030000000000000000000000060000000E00000000000000000000005F5F6C615F73796D626F6C5F707472005F5F44415441000000000000000000005030000001000000600000000000000050300000030000000000000000000000070000001100000000000000000000005F5F6F626A635F696D616765696E666F5F5F4441544100000000000000000000B0300000010000000800000000000000B0300000020000000000000000000000000000000000000000000000000000005F5F6F626A635F73656C7265667300005F5F4441544100000000000000000000B830000001000000C000000000000000B8300000030000000000000000000000050000100000000000000000000000005F5F6F626A635F6D73677265667300005F5F44415441000000000000000000008031000001000000500000000000000080310000040000000000000000000000000000000000000000000000000000005F5F6F626A635F636C617373726566735F5F4441544100000000000000000000D0310000010000004000000000000000D0310000030000000000000000000000000000100000000000000000000000005F5F6366737472696E670000000000005F5F44415441000000000000000000001032000001000000000200000000000010320000030000000000000000000000000000000000000000000000000000005F5F636F6D6D6F6E00000000000000005F5F444154410000000000000000000010340000010000002000000000000000000000000300000000000000000000000100000000000000000000000000000019000000480000005F5F4C494E4B45444954000000000000004000000100000000100000000000000040000000000000AC08000000000000070000000100000000000000000000002200008030000000004000001800000018400000D80100000000000000000000F041000000010000F042000080000000020000001800000078430000240000002C460000800200000B00000050000000000000000200000002000000080000000A0000001A000000000000000000000000000000000000000000000000000000B84500001D000000000000000000000000000000000000000E000000200000000C0000002F7573722F6C69622F64796C64000000000000001B00000018000000D027074F8DEA3EA8880EA672A9795549240000001000000000070A0000070A0005000000B8000000040000002A0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000901000000100000000000000000000000000000000000000000000000000000000000000000000000C00000058000000180000000200000000001100000001002F53797374656D2F4C6962726172792F4672616D65776F726B732F436F636F612E6672616D65776F726B2F56657273696F6E732F412F436F636F6100000000000C00000038000000180000000200000000019F00000001002F7573722F6C69622F6C696253797374656D2E422E64796C69620000000000000C0000003800000018000000020000000000E400000001002F7573722F6C69622F6C69626F626A632E412E64796C696200000000000000000C00000068000000180000000200000000157B02000096002F53797374656D2F4C6962726172792F4672616D65776F726B732F436F7265466F756E646174696F6E2E6672616D65776F726B2F56657273696F6E732F412F436F7265466F756E646174696F6E0000000C0000006000000018000000020000000019410300002C012F53797374656D2F4C6962726172792F4672616D65776F726B732F466F756E646174696F6E2E6672616D65776F726B2F56657273696F6E732F432F466F756E646174696F6E0000000C000000580000001800000002000000002F720400002D002F53797374656D2F4C6962726172792F4672616D65776F726B732F4170704B69742E6672616D65776F726B2F56657273696F6E732F432F4170704B697400000026000000100000007043000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006A004889E54883E4F0488B7D08488D751089FA83C201C1E2034801F24889D1EB044883C1084883390075F64883C108E80C00000089C7E899190000F490909090554889E54881ECD000000089F88945FC488975F0488B05E520000048894590488B058A200000488B4D90488D157F2000004889CF4889D6FFD048894598488B05A41F0000488B4D984889CF4889C6E86519000048894588488B45F0488B004889C7E81A020000EB00C7458400000000E97C010000488B8568FFFFFF4889C7E82319000048898558FFFFFFEB00488B8558FFFFFF4889C148898D78FFFFFF488B0D6420000048894DA0488B0D01200000488B55A0488D35F61F00004889D7FFD148898550FFFFFFEB00488B8550FFFFFF488945A8488B0D0E1F0000488B55A84889D74889CEE8CF18000048898548FFFFFFEB00488B8548FFFFFF4889C148898D70FFFFFF488B8D70FFFFFF48894DB0488B0DDB1E0000488B55B0BE020000004889D74889B540FFFFFF4889CE488B9540FFFFFFE881180000EB00488B8570FFFFFF488945B8488B8578FFFFFF488945C0488B05A21E0000488B4DC04889CF4889C6E85318000048898538FFFFFFEB00488B058B1E0000488B4DB84889CF4889C6488B9538FFFFFFE82D180000EB00488B8570FFFFFF488945C8488B05691E0000488B4DC84889CF4889C6E80A180000EB00C7458401000000E8F0170000EB328B8564FFFFFF8945E8488B8568FFFFFF488945E0E8D5170000488B45E048898568FFFFFF8B45E8898564FFFFFFE980000000488B4588488945D0488B05111E0000488B4DD04889CF4889C6E8AA1700008B45848945DC8B45DC8945EC8B45EC4881C4D00000005DC348898568FFFFFF488B8568FFFFFF89D0898564FFFFFFEB1848898568FFFFFF488B8568FFFFFF89D0898564FFFFFFEB15B8010000008B8D64FFFFFF39C10F840BFEFFFFEB05E94EFFFFFF488B8568FFFFFF4889C7E8F716000090554889E54881EC70080000488B05E61C0000488B00488945F848897DF04889E048898550FDFFFF488B05621E0000488985A0FBFFFF488B055C1D0000488B8DA0FBFFFF4889CF4889C6E8EA160000488985E8FAFFFFEB00488B85E8FAFFFF48898598FBFFFFE8B6160000488985E0FAFFFFEB00488B85E0FAFFFF4889C148898DA8FBFFFF488B0D151D0000488B95A8FBFFFF4889D74889CEE89B160000488985D8FAFFFFEB00488BBDD8FAFFFFE850160000EB00488B8598FBFFFF488985B0FBFFFF488B05DF1C0000488B8DB0FBFFFF4889CF4889C6E85D160000488985D0FAFFFFEB00488B85D0FAFFFF48898590FBFFFF488B8D90FBFFFF48898DB8FBFFFF488B0D391D0000488B95B8FBFFFF488D352B1D0000488D3DA41D00004889BDC8FAFFFF4889D7488B95C8FAFFFFFFD1488985C0FAFFFFEB00488B85C0FAFFFF4889C148898D88FBFFFF48C78580FBFFFF00000000488B8D88FBFFFF4883F9000F8441010000488B05241D0000488985C0FBFFFF488B051E1C0000488B8DC0FBFFFF4889CF4889C6E8AC150000488985B8FAFFFFEB00488B85B8FAFFFF4889C148898DC8FBFFFF488B0D031C0000488B95C8FBFFFF4889D74889CEE879150000488985B0FAFFFFEB00488B85B0FAFFFF4889C148898DD0FBFFFF488B0DD81B0000488B95D0FBFFFF488BB588FBFFFF4889D74889B5A8FAFFFF4889CE488B95A8FAFFFFE831150000488985A0FAFFFFEB00488B85A0FAFFFF48898518FBFFFF488B8D18FBFFFF48898DD8FBFFFF488B0D851B0000488B95D8FBFFFF488D359F1C00004889D74889B598FAFFFF4889CE488B9598FAFFFFE8DE14000048898590FAFFFFEB00488B8590FAFFFF4889C148898DE0FBFFFF488B0D451B0000488B95E0FBFFFF4889D74889CEE8AB14000048898588FAFFFFEB00488B8588FAFFFF48898580FBFFFFEB0E488D05BB15000048898580FBFFFF488B8580FBFFFFB9010000004889C789CEE83E14000048898580FAFFFFEB00488B8580FAFFFF48898578FBFFFF48C78570FBFFFF00000000488B8D78FBFFFF4883F9007433488B8578FBFFFF488D0DB71500004889C74889CEE8FC13000048898578FAFFFFEB00488B8578FAFFFF4889C148898D70FBFFFF488B8570FBFFFF4883F8000F851D010000488B05541B0000488985E8FBFFFF488B053E1B0000488985F0FBFFFF488B05381A0000488B8DF0FBFFFF4889CF4889C6E8C613000048898570FAFFFFEB00488B8570FAFFFF4889C148898DF8FBFFFF488B0D351A0000488B95F8FBFFFF31F6488D3D7D1B00004C8D05561B00004889BD68FAFFFF4889D74889B560FAFFFF4889CE488B9568FAFFFF4C89C14C8B8560FAFFFFE86413000048898558FAFFFFEB00488B05EC190000488B8DE8FBFFFF31D2488D354C1B00004889CF4889B550FAFFFF4889C6488B8550FAFFFF48899548FAFFFF4889C2488B8D58FAFFFF4C8B8548FAFFFFE81313000048898540FAFFFFEB00488B8540FAFFFF4889C148898D00FCFFFF488B0D92190000488B9500FCFFFF4889D74889CEE8E0120000EB00488B8590FBFFFF48898508FCFFFF488B05D1190000488B8D08FCFFFF488D15C3190000488D35DC1A00004889CF4889B538FAFFFF4889D6488B9538FAFFFFFFD048898530FAFFFFEB00488B8530FAFFFF4889C148898D68FBFFFF488B8D68FBFFFF4883F9000F851D010000488B05CC19000048898510FCFFFF488B05B619000048898518FCFFFF488B05B0180000488B8D18FCFFFF4889CF4889C6E83E12000048898528FAFFFFEB00488B8528FAFFFF4889C148898D20FCFFFF488B0DAD180000488B9520FCFFFF31F6488D3D551A00004C8D05CE1900004889BD20FAFFFF4889D74889B518FAFFFF4889CE488B9520FAFFFF4C89C14C8B8518FAFFFFE8DC11000048898510FAFFFFEB00488B0564180000488B8D10FCFFFF31D2488D35C41900004889CF4889B508FAFFFF4889C6488B8508FAFFFF48899500FAFFFF4889C2488B8D10FAFFFF4C8B8500FAFFFFE88B110000488985F8F9FFFFEB00488B85F8F9FFFF4889C148898D28FCFFFF488B0D0A180000488B9528FCFFFF4889D74889CEE858110000EB00488B8598FBFFFF48898530FCFFFF488B05E9170000488B8D30FCFFFF4889CF4889C6E82F110000488985F0F9FFFFEB00488B85F0F9FFFF48898560FBFFFF488B8D60FBFFFF48898D38FCFFFF488B0DB3170000488B9538FCFFFF488D355D1900004889D74889B5E8F9FFFF4889CE488B95E8F9FFFFE8DC100000488985E0F9FFFFEB00488B85E0F9FFFF48898558FBFFFF488B0D2618000048898D40FCFFFF488B0D68170000488B9540FCFFFF488BB558FBFFFF4030FF4C8D05201900004088BDDFF9FFFF4889D74889B5D0F9FFFF4889CE4C89C2488B8DD0F9FFFF448A85DFF9FFFF4488C0E86B100000488985C8F9FFFFEB00488B85C8F9FFFF4889C148898D50FBFFFF488B0DBA17000048898D48FCFFFF488B0DFC160000488B9548FCFFFF4889D74889CEE82A100000488985C0F9FFFFEB00488B85C0F9FFFF48898548FBFFFF488B8D48FBFFFF48898D50FCFFFF488B0DC6160000488B9550FCFFFF488BB558FBFFFF31FF4889BDB8F9FFFF4889D74889B5B0F9FFFF4889CE488B95B0F9FFFF488B8DB8F9FFFFE8C70F0000488985A8F9FFFFEB00488B85A8F9FFFF48898540FBFFFF488B8D40FBFFFF4883F9000F851D010000488B05F816000048898558FCFFFF488B05E216000048898560FCFFFF488B05DC150000488B8D60FCFFFF4889CF4889C6E86A0F0000488985A0F9FFFFEB00488B85A0F9FFFF4889C148898D68FCFFFF488B0DD9150000488B9568FCFFFF31F6488D3DE11700004C8D05FA1600004889BD98F9FFFF4889D74889B590F9FFFF4889CE488B9598F9FFFF4C89C14C8B8590F9FFFFE8080F000048898588F9FFFFEB00488B0590150000488B8D58FCFFFF31D2488D35F01600004889CF4889B580F9FFFF4889C6488B8580F9FFFF48899578F9FFFF4889C2488B8D88F9FFFF4C8B8578F9FFFFE8B70E000048898570F9FFFFEB00488B8570F9FFFF4889C148898D70FCFFFF488B0D36150000488B9570FCFFFF4889D74889CEE8840E0000EB0048C78558FDFFFF0000000048C78560FDFFFF0000000048C78568FDFFFF0000000048C78570FDFFFF0000000048C78578FDFFFF0000000048C78580FDFFFF0000000048C78588FDFFFF0000000048C78590FDFFFF00000000488B8540FBFFFF48898578FCFFFF488B052D150000488B8D78FCFFFF488D9598FDFFFF488DB558FDFFFFBF100000004C8D050C1500004889BD68F9FFFF4889CF4889B560F9FFFF4C89C6488B8D60F9FFFF48899558F9FFFF4889CA488B8D58F9FFFF4C8B8568F9FFFFFFD048898550F9FFFFEB00488B8550F9FFFF48898518FEFFFF488B8D18FEFFFF4883F9000F84F2010000488B8568FDFFFF488B0048898520FEFFFF48C78528FEFFFF00000000488B8568FDFFFF488B00488B8D20FEFFFF4839C87423488B8540FBFFFF48898580FCFFFF488B8580FCFFFF30C94889C788C8E83E0D0000EB00488B8560FDFFFF488B8D28FEFFFF488B04C848898510FBFFFF488B8528FEFFFF48B901000000000000004801C848898528FEFFFF488B8510FBFFFF48898588FCFFFF488B05C9130000488B8D88FCFFFF488D15B31500004889CF4889C6E8E00C000088C1888D4FF9FFFFEB008A854FF9FFFF3C00747E488B8550FBFFFF48898590FCFFFF488B058F130000488B8D90FCFFFF488B9558FBFFFF488BB510FBFFFF488D3D831500004530C04889BD40F9FFFF4889CF4889B538F9FFFF4889C6488B8540F9FFFF48899530F9FFFF4889C2488B8D30F9FFFF488B8538F9FFFF4488852FF9FFFF4989C08A852FF9FFFFE8500C0000EB00488B8528FEFFFF488B8D18FEFFFF4839C80F82BCFEFFFF488B0548130000488B8D78FCFFFF488D9598FDFFFF488DB558FDFFFFBF100000004C8D05271300004889BD20F9FFFF4889CF4889B518F9FFFF4C89C6488B8D18F9FFFF48899510F9FFFF4889CA488B8D10F9FFFF4C8B8520F9FFFFFFD048898508F9FFFFEB00488B8508F9FFFF48898518FEFFFF488B8D18FEFFFF4883F9000F852CFEFFFF48C78510FBFFFF00000000EB0B48C78510FBFFFF00000000488B050B13000048898598FCFFFF488B053D120000488B8D98FCFFFF488B9560FBFFFF4030F6488D3D751400004889BD00F9FFFF4889CF4088B5FFF8FFFF4889C6488B8500F9FFFF488995F0F8FFFF4889C2488B8DF0F8FFFF8A85FFF8FFFFE8360B0000488985E8F8FFFFEB00488B85E8F8FFFF4889C148898D38FBFFFF488B8D90FBFFFF48898DA0FCFFFF488B0D0F120000488B95A0FCFFFF488D3501120000488D3D1A1400004889BDE0F8FFFF4889D7488B95E0F8FFFFFFD1488985D8F8FFFFEB00488B85D8F8FFFF4889C148898D30FBFFFF488B8D30FBFFFF4883F9007541488B0531120000488985A8FCFFFF488B0583110000488B8DA8FCFFFF4889CF4889C6E8910A0000488985D0F8FFFFEB00488B85D0F8FFFF4889C148898D30FBFFFF488B8590FBFFFF488985B0FCFFFF488B056A110000488B8DB0FCFFFF488D155C110000488D35951300004889CF4889B5C8F8FFFF4889D6488B95C8F8FFFFFFD0488985C0F8FFFFEB00488B85C0F8FFFF4889C148898D28FBFFFF488B8D28FBFFFF4883F9007541488B0589110000488985B8FCFFFF488B05DB100000488B8DB8FCFFFF4889CF4889C6E8E9090000488985B8F8FFFFEB00488B85B8F8FFFF4889C148898D28FBFFFF488B8530FBFFFF488985C0FCFFFF488B05E2100000488B8DC0FCFFFF488D15D41000004889CF4889D6FFD0488985B0F8FFFFEB00488B85B0F8FFFF89C1488B9528FBFFFF488995C8FCFFFF488B15A5100000488BB5C8FCFFFF488D3D971000004889BDA8F8FFFF4889F7488BB5A8F8FFFF898DA4F8FFFFFFD248898598F8FFFFEB00488B8598F8FFFF89C18B95A4F8FFFF89D601CE83C60489B524FBFFFF8B8D24FBFFFF898DD4FCFFFF8B8DD4FCFFFF8B8DD4FCFFFF8B8DD4FCFFFF48B908000000000000008BB5D4FCFFFF8BB5D4FCFFFF4863F6480FAFF189F189C9488D490F4883E1F04889E64829CE4889F44889B5D8FCFFFFC78520FBFFFF00000000488B8DD8FCFFFF488B75F04863BD20FBFFFF488934F98B8D20FBFFFF8D4901898D20FBFFFF488BB550FBFFFF4889B5E0FCFFFF488B3DFE0E00004889BD90F8FFFF4889F7488BB590F8FFFF898D8CF8FFFFE87A08000048898580F8FFFFEB00488BBD80F8FFFFE847080000488B8DD8FCFFFF8B958CF8FFFF4863F2488904F18B8520FBFFFF83C001898520FBFFFF8B8520FBFFFF488B8D38FBFFFF48898DE8FCFFFF488B0D8F0E0000488BB5E8FCFFFF4889F74889CE89857CF8FFFFE80F08000048898570F8FFFFEB00488BBD70F8FFFFE8DC070000488B8DD8FCFFFF8B957CF8FFFF4863F2488904F18B8520FBFFFF83C001898520FBFFFF48C78530FEFFFF0000000048C78538FEFFFF0000000048C78540FEFFFF0000000048C78548FEFFFF0000000048C78550FEFFFF0000000048C78558FEFFFF0000000048C78560FEFFFF0000000048C78568FEFFFF00000000488B8530FBFFFF488985F0FCFFFF488B05820E0000488B8DF0FCFFFF488DB570FEFFFF488DBD30FEFFFF41B8100000004C8D0D600E00004889BD68F8FFFF4889CF4889B560F8FFFF4C89CE488B8D68F8FFFF4889CA488B8D60F8FFFFFFD048898558F8FFFFEB00488B8558F8FFFF488985F0FEFFFF488B8DF0FEFFFF4883F9000F8419020000488B8540FEFFFF488B00488985F8FEFFFF48C78500FFFFFF00000000488B8540FEFFFF488B00488B8DF8FEFFFF4839C87423488B8530FBFFFF488985F8FCFFFF488B85F8FCFFFF30C94889C788C8E8A0060000EB00488B8538FEFFFF488B8D00FFFFFF488B04C848898508FBFFFF488B8500FFFFFF48B901000000000000004801C848898500FFFFFF488B8508FBFFFF48898500FDFFFF488B8598FBFFFF48898508FDFFFF488B05F50C0000488B8D08FDFFFF4889CF4889C6E83B06000048898550F8FFFFEB00488B05130D0000488B8D00FDFFFF488D15850F00004889CF4889C6488B8D50F8FFFFE80B06000048898548F8FFFFEB00488B8548F8FFFF48898508FBFFFF8B8D20FBFFFF488B9508FBFFFF48899510FDFFFF488B15410C0000488BB510FDFFFF4889F74889D6898D44F8FFFFE8C105000048898538F8FFFFEB00488BBD38F8FFFFE88E050000488B8DD8FCFFFF8B9544F8FFFF4863F2488904F18B8520FBFFFF83C001898520FBFFFF488B8500FFFFFF488B8DF0FEFFFF4839C80F8295FEFFFF488B05830C0000488B8DF0FCFFFF488D9570FEFFFF488DB530FEFFFFBF100000004C8D05620C00004889BD30F8FFFF4889CF4889B528F8FFFF4C89C6488B8D28F8FFFF48899520F8FFFF4889CA488B8D20F8FFFF4C8B8530F8FFFFFFD048898518F8FFFFEB00488B8518F8FFFF488985F0FEFFFF488B8DF0FEFFFF4883F9000F8505FEFFFF48C78508FBFFFF00000000EB0B48C78508FBFFFF000000008B8520FBFFFF488B8D68FBFFFF48898D18FDFFFF488B0D220B0000488B9518FDFFFF4889D74889CE898514F8FFFFE8A204000048898508F8FFFFEB00488BBD08F8FFFFE86F040000488B8DD8FCFFFF8B9514F8FFFF4863F2488904F18B8520FBFFFF83C001898520FBFFFF48C78508FFFFFF0000000048C78510FFFFFF0000000048C78518FFFFFF0000000048C78520FFFFFF0000000048C78528FFFFFF0000000048C78530FFFFFF0000000048C78538FFFFFF0000000048C78540FFFFFF00000000488B8528FBFFFF48898520FDFFFF488B05150B0000488B8D20FDFFFF488DB548FFFFFF488DBD08FFFFFF41B8100000004C8D0DF30A00004889BD00F8FFFF4889CF4889B5F8F7FFFF4C89CE488B8D00F8FFFF4889CA488B8DF8F7FFFFFFD0488985F0F7FFFFEB00488B85F0F7FFFF488945C8488B4DC84883F9000F84FB010000488B8518FFFFFF488B00488945D048C745D800000000488B8518FFFFFF488B00488B4DD04839C87423488B8528FBFFFF48898528FDFFFF488B8528FDFFFF30C94889C788C8E842030000EB00488B8510FFFFFF488B4DD8488B04C848898500FBFFFF488B45D848B901000000000000004801C8488945D8488B8500FBFFFF48898530FDFFFF488B8598FBFFFF48898538FDFFFF488B05A0090000488B8D38FDFFFF4889CF4889C6E8E6020000488985E8F7FFFFEB00488B05BE090000488B8D30FDFFFF488D15300C00004889CF4889C6488B8DE8F7FFFFE8B6020000488985E0F7FFFFEB00488B85E0F7FFFF48898500FBFFFF8B8D20FBFFFF488B9500FBFFFF48899540FDFFFF488B15EC080000488BB540FDFFFF4889F74889D6898DDCF7FFFFE86C020000488985D0F7FFFFEB00488BBDD0F7FFFFE839020000488B8DD8FCFFFF8B95DCF7FFFF4863F2488904F18B8520FBFFFF83C001898520FBFFFF488B45D8488B4DC84839C80F82A7FEFFFF488B0534090000488B8D20FDFFFF488D9548FFFFFF488DB508FFFFFFBF100000004C8D05130900004889BDC8F7FFFF4889CF4889B5C0F7FFFF4C89C6488B8DC0F7FFFF488995B8F7FFFF4889CA488B8DB8F7FFFF4C8B85C8F7FFFFFFD0488985B0F7FFFFEB00488B85B0F7FFFF488945C8488B4DC84883F9000F8520FEFFFF48C78500FBFFFF00000000EB0B48C78500FBFFFF00000000488B85D8FCFFFF488B8D70FBFFFF8B9524FBFFFF4883EC404889E6488D3DDA03000048897E1848897E10488D3D7F03000048897E0848893EC7463800000000C7463000000000C7462800000000C746200000000031F631FF4889BDA8F7FFFF89D789B5A4F7FFFF4889C68B95A4F7FFFF488B85A8F7FFFF48898D98F7FFFF4889C1448B85A4F7FFFF4989C1488B8598F7FFFFFFD04883C44089C1898D94F7FFFFEB008B8594F7FFFF89854CFDFFFF488B8D50FDFFFF4889CC8B8D4CFDFFFF894DECEB348B85F4FAFFFF8945E8488B85F8FAFFFF488945E0488B8550FDFFFF4889C4488B45E0488985F8FAFFFF8B45E88985F4FAFFFFEB3F8B45EC488B0D4B060000488B09488B55F84839D1898590F7FFFF75328B8590F7FFFF4889EC5DC3488985F8FAFFFF488B85F8FAFFFF89D08985F4FAFFFFEB8D488B85F8FAFFFF4889C7E805000000E806000000FF2504060000FF2506060000FF2508060000FF250A060000FF250C060000FF250E060000FF2510060000FF2512060000FF2514060000FF2516060000FF2518060000FF251A06000000004C8D1D990500004153FF2589050000906800000000E9E6FFFFFF6821000000E9DCFFFFFF6839000000E9D2FFFFFF6846000000E9C8FFFFFF6854000000E9BEFFFFFF6861000000E9B4FFFFFF686D000000E9AAFFFFFF687C000000E9A0FFFFFF6894000000E996FFFFFF68AD000000E98CFFFFFF68C4000000E982FFFFFF68E5000000E978FFFFFFFF9BBC000334000000005E00000000000000005E0000000800000026020000017B000000330100003E02000000AE010000D100000000000000000100E4040000FF9B9C00031A4300000003160000CA1600000046160000B000000000000000004E53457863657074696F6E004A564D52756E74696D650000436F6E74656E74732F486F6D652F6A72652F6C69622F6A6C692F6C69626A6C692E64796C696200002F4C6962726172792F496E7465726E657420506C75672D496E732F4A6176614170706C6574506C7567696E2E706C7567696E2F436F6E74656E74732F486F6D652F6C69622F6A6C692F6C69626A6C692E64796C6962004A4C495F4C61756E636800004A52454C6F61644572726F72004A6176614C61756E63684572726F72004A564D4D61696E436C6173734E616D65004D61696E436C6173734E616D655265717569726564002F436F6E74656E74732F4A617661002D446A6176612E636C6173732E706174683D25402F436C6173736573004A6176614469726563746F72794E6F74466F756E64002E6A6172003A25402F254000000000002D446A6176612E6C6962726172792E706174683D25402F436F6E74656E74732F4D61634F53004A564D4F7074696F6E73004A564D417267756D656E747300244150505F524F4F54006A61766100737472696E6742795265706C6163696E674F6363757272656E6365734F66537472696E673A77697468537472696E673A00617272617900617070656E64466F726D61743A006861735375666669783A00636F6E74656E74734F664469726563746F72794174506174683A6572726F723A0064656661756C744D616E6167657200737472696E6757697468466F726D61743A00737472696E674279417070656E64696E67537472696E673A0062756E646C655061746800726169736500657863657074696F6E576974684E616D653A726561736F6E3A75736572496E666F3A006C6F63616C697A6564537472696E67466F724B65793A76616C75653A7461626C653A0066696C6553797374656D526570726573656E746174696F6E00737472696E674279417070656E64696E6750617468436F6D706F6E656E743A006275696C74496E506C7567496E735061746800696E666F44696374696F6E6172790055544638537472696E67006D61696E42756E646C6500647261696E0072756E4D6F64616C007365744D657373616765546578743A00726561736F6E00736574416C6572745374796C653A00696E6974006175746F72656C6561736500616C6C6F63006F626A656374466F724B65793A00636F756E744279456E756D65726174696E675769746853746174653A6F626A656374733A636F756E743A00636F756E7400010000001C00000001000000200000000100000024000000020000000000005140300000901000004C0000003C000000472A0000000000004C000000D0100000182B000050130000582B0000030000000C000300180001000000000140000000C00200000000000000000000001C00000000000000017A504C5200017810079BC500000010100C070890010000340000002400000040E1FFFFFFFFFFFF7F020000000000000877FBFFFFFFFFFFFF04010000000E10860204030000000D0600000000000000340000005C00000088E3FFFFFFFFFFFFF616000000000000087FFBFFFFFFFFFFFF04010000000E10860204030000000D060000000000000000000000000000000000000001000000103400000100000018340000010000002034000001000000283400000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000A02A000001000000AA2A000001000000B42A000001000000BE2A000001000000C82A000001000000D22A000001000000DC2A000001000000E62A000001000000F02A000001000000FA2A000001000000042B0000010000000E2B0000010000000000000000000000A52E000001000000962E0000010000008F2E0000010000007F2E000001000000762E000001000000702E000001000000652E0000010000005A2E0000010000004B2E000001000000382E000001000000182E000001000000FF2D000001000000DC2D000001000000B92D000001000000B32D000001000000A82D0000010000008F2D0000010000007D2D0000010000006E2D0000010000004D2D000001000000422D000001000000342D0000010000002E2D000001000000FD2C00000100000000000000000000000000000000000000B62E0000010000000000000000000000BC2E0000010000000000000000000000CA2E0000010000000000000000000000F52E0000010000000000000000000000AA2E000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C807000000000000842B0000010000000A000000000000000000000000000000C807000000000000902B00000100000026000000000000000000000000000000C807000000000000AC2C00000100000000000000000000000000000000000000C8070000000000001A2C0000010000000C000000000000000000000000000000C807000000000000272C0000010000000F000000000000000000000000000000C807000000000000372C00000100000010000000000000000000000000000000C807000000000000482C00000100000015000000000000000000000000000000C8070000000000005E2C0000010000000E000000000000000000000000000000C8070000000000006D2C0000010000001C000000000000000000000000000000C8070000000000008A2C00000100000015000000000000000000000000000000C807000000000000A02C00000100000004000000000000000000000000000000C807000000000000A52C00000100000006000000000000000000000000000000C807000000000000B02C00000100000025000000000000000000000000000000C807000000000000D62C0000010000000A000000000000000000000000000000C807000000000000E12C0000010000000C000000000000000000000000000000C807000000000000EE2C0000010000000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011220055455C416018428004087050800F1851000000000012405F5F5F737461636B5F63686B5F677561726400517248904064796C645F737475625F62696E6465720080D8FFFFFFFFFFFFFFFF019013405F5F5F6F626A635F706572736F6E616C6974795F763000801090405F6F626A635F6D736753656E645F66697875700080B802C004089014405F4F424A435F434C4153535F245F4E53417272617900804090405F4F424A435F434C4153535F245F4E53457863657074696F6E0080D8FFFFFFFFFFFFFFFF0190405F4F424A435F4548545950455F245F4E53457863657074696F6E0080C8FCFFFFFFFFFFFFFF0190405F5F5F4346436F6E7374616E74537472696E67436C6173735265666572656E63650080D003C00F189015405F4F424A435F434C4153535F245F4E534175746F72656C65617365506F6F6C0080D8FBFFFFFFFFFFFFFF0190405F4F424A435F434C4153535F245F4E5342756E646C6500800890405F4F424A435F434C4153535F245F4E5346696C654D616E6167657200801090405F4F424A435F434C4153535F245F4E534D757461626C65537472696E670080F0FFFFFFFFFFFFFFFF0190405F4F424A435F434C4153535F245F4E53537472696E670080089016405F4F424A435F434C4153535F245F4E53416C6572740080D0FFFFFFFFFFFFFFFF01900000725012405F5F556E77696E645F526573756D655F6F725F52657468726F77009000725812405F5F5F737461636B5F63686B5F6661696C009000726012405F6368646972009000726812405F646C6F70656E009000727012405F646C73796D009000727812405F6578697400900072800112405F73747264757000900072880115405F4E53486F6D654469726563746F727900900072900113405F6F626A635F626567696E5F636174636800900072980113405F6F626A635F656E645F636174636800900072A00113405F6F626A635F656E756D65726174696F6E4D75746174696F6E00900072A80113405F6F626A635F6D736753656E6400900000000000000000025F000C7374617274005300055F002F6D61696E00586C61756E6368005D4E584172670062656E7669726F6E007400026D685F657865637574655F686561646572004F5F70726F676E616D6500790200000003009021000300D021000300D02600000263006A76006F030090680003009868000300A068000300A8680000009021408005000000020000000E040000182B000001000000140000000E040000582B000001000000260000000F11000010340000010000002E0000000F1100001834000001000000360000000F1100002834000001000000420000000F0110000000000001000000560000000F11000020340000010000005F0000000F0100005013000001000000670000000F010000D0100000010000006D0000000F010000901000000100000073000000010000050000000000000000840000000100000600000000000000009A000000010000040000000000000000B0000000010000050000000000000000D0000000010000050000000000000000E7000000010000040000000000000000010100000100000500000000000000001D0100000100000500000000000000003B010000010000050000000000000000520100000100000400000000000000006D01000001000002000000000000000088010000010000040000000000000000AA010000010000030000000000000000C1010000010000020000000000000000D3010000010000020000000000000000E6010000010000020000000000000000ED010000010000020000000000000000F5010000010000020000000000000000FC0100000100000200000000000000000202000001000003000000000000000014020000010000030000000000000000240200000100000300000000000000003E0200000100000300000000000000004C02000001000003000000000000000060020000010000020000000000000000680200000100000200000000000000001400000017000000190000001A0000001B0000001C000000220000000A0000001D0000001E0000001F0000002000000023000000000000401300000016000000180000001400000017000000190000001A0000001B0000001C000000220000000A0000001D0000001E0000001F0000002000000020004743435F6578636570745F7461626C6531004743435F6578636570745F7461626C6532005F4E5841726763005F4E5841726776005F5F5F70726F676E616D65005F5F6D685F657865637574655F686561646572005F656E7669726F6E005F6C61756E6368005F6D61696E007374617274005F4E53486F6D654469726563746F7279005F4F424A435F434C4153535F245F4E53416C657274005F4F424A435F434C4153535F245F4E534172726179005F4F424A435F434C4153535F245F4E534175746F72656C65617365506F6F6C005F4F424A435F434C4153535F245F4E5342756E646C65005F4F424A435F434C4153535F245F4E53457863657074696F6E005F4F424A435F434C4153535F245F4E5346696C654D616E61676572005F4F424A435F434C4153535F245F4E534D757461626C65537472696E67005F4F424A435F434C4153535F245F4E53537472696E67005F4F424A435F4548545950455F245F4E53457863657074696F6E005F5F556E77696E645F526573756D655F6F725F52657468726F77005F5F5F4346436F6E7374616E74537472696E67436C6173735265666572656E6365005F5F5F6F626A635F706572736F6E616C6974795F7630005F5F5F737461636B5F63686B5F6661696C005F5F5F737461636B5F63686B5F6775617264005F6368646972005F646C6F70656E005F646C73796D005F65786974005F6F626A635F626567696E5F6361746368005F6F626A635F656E645F6361746368005F6F626A635F656E756D65726174696F6E4D75746174696F6E005F6F626A635F6D736753656E64005F6F626A635F6D736753656E645F6669787570005F7374726475700064796C645F737475625F62696E6465720000000000000000'

#------------------------------------------------------------------------------
# The Localizable.strings file
#------------------------------------------------------------------------------
localizable_strings = """"JRELoadError" = "Unable to load Java Runtime Environment.";
"MainClassNameRequired" = "Main class name is required.";
"JavaDirectoryNotFound" = "Unable to enumerate Java directory contents.";
"""

#------------------------------------------------------------------------------
# The info.plist file with placeholders
#------------------------------------------------------------------------------
info_plist = """<?xml version="1.0" ?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
    <!-- This file was autogenerated by jar2app {version} (https://github.com/Jorl17/jar2app) -->
    <dict>
    <key>CFBundleDevelopmentRegion</key>
    <string>English</string>

    <key>CFBundleExecutable</key>
    <string>{executable}</string>

    <key>CFBundleIconFile</key>
    <string>{icon}</string>

    <key>CFBundleIdentifier</key>
    <string>{bundle_identifier}</string>

    <key>CFBundleDisplayName</key>
    <string>{bundle_displayname}</string>

    <key>CFBundleInfoDictionaryVersion</key>
    <string>6.0</string>

    <key>CFBundleName</key>
    <string>{bundle_name}</string>

    <key>CFBundlePackageType</key>
    <string>APPL</string>

    {retina_support}

    <key>CFBundleShortVersionString</key>
    <string>{short_version_string}</string>

    <key>CFBundleSignature</key>
    <string>{unique_signature}</string>

    <key>CFBundleVersion</key>
    <string>{bundle_version}</string>

    <key>NSHumanReadableCopyright</key>
    <string>{copyright}</string>

    {jdk}

    <key>JVMMainClassName</key>
    <string>{main_class_name}</string>

    <key>JVMOptions</key>
    <array>
{jvm_options}
    </array>

    <key>JVMArguments</key>
    <array>
{jvm_arguments}
    </array>

    </dict>
</plist>
"""

retina_support_string = """<key>NSPrincipalClass</key>
    <string>NSApplication</string>
    <key>NSHighResolutionCapable</key>
    <string>True</string>"""


#------------------------------------------------------------------------------
# Create a directory and ignore the "File already exists" error
#------------------------------------------------------------------------------
def mkdir_ignore_exists(p):
    try:
        os.mkdir(p)
        return True
    except FileExistsError:
        return False

#------------------------------------------------------------------------------
# Make a file executable
#------------------------------------------------------------------------------
def make_executable(path):
    mode = os.stat(path).st_mode
    mode |= (mode & 0o444) >> 2
    os.chmod(path, mode)

#------------------------------------------------------------------------------
# Just strip the extension from a name
#------------------------------------------------------------------------------
def strip_extension_from_name(name):
    return os.path.splitext(name)[0]

#------------------------------------------------------------------------------
# Determine the main class in a JAR file. This basically involves searching
# through the JAR (it's just a zip file), locating the MANIFEST.MF file,
# decompressing it and then finding the main-class line.
#------------------------------------------------------------------------------
def find_jar_mainclass(jar_file):
    f = ZipFile(jar_file, 'r')
    for file in f.infolist():
        orig_fn = file.filename
        lower_fn = orig_fn.lower()
        if lower_fn.startswith('meta-inf') and lower_fn.endswith('manifest.mf'):
            manifest_mf = f.read(orig_fn)
            for line in manifest_mf.decode().split('\n'):
                if line.strip().lower().startswith('main-class'):
                    return line.split(':')[1].strip()

#------------------------------------------------------------------------------
# Build the main directory structure of the .App. It should look like
# <appname>.App/
#              Contents/
#                       Java/
#                       MacOS/
#                       Resources/
#                                 en.lproj/
#------------------------------------------------------------------------------
def build_directory_structure(app_full_path):
    mkdir_ignore_exists(os.path.dirname(app_full_path)) #Base output directory where the app is placed. Create it.
    mkdir_ignore_exists(app_full_path)
    mkdir_ignore_exists(os.path.join(app_full_path, 'Contents'))
    mkdir_ignore_exists(os.path.join(app_full_path, 'Contents', 'Java'))
    mkdir_ignore_exists(os.path.join(app_full_path, 'Contents', 'MacOS'))
    mkdir_ignore_exists(os.path.join(app_full_path, 'Contents', 'PlugIns'))
    mkdir_ignore_exists(os.path.join(app_full_path, 'Contents', 'Resources'))
    mkdir_ignore_exists(os.path.join(app_full_path, 'Contents', 'Resources', 'en.lproj'))

#------------------------------------------------------------------------------
# Write the plist file in the desired output folder. Note that these arguments
# are passed directly to the info_plist string, so some of them (jdk,
# jvm_arguments...) should have a bit of XML.
#
# The destination folder is typically <appname>.App/Contents
#------------------------------------------------------------------------------
def create_plist_file(destination_folder, icon, bundle_identifier, bundle_displayname, bundle_name,bundle_version,
                      short_version_string,copyright_str, main_class_name, jvm_arguments, jvm_options, jdk,
                      unique_signature, retina_support, executable):
    filled_info_plist=info_plist.format(icon=icon,
                                        bundle_identifier=bundle_identifier,
                                        bundle_displayname=bundle_displayname,
                                        bundle_name=bundle_name,
                                        bundle_version=bundle_version,
                                        short_version_string=short_version_string,
                                        copyright=copyright_str,
                                        main_class_name=main_class_name,
                                        jvm_arguments=jvm_arguments,
                                        jvm_options=jvm_options,
                                        jdk=jdk,
                                        unique_signature=unique_signature,
                                        retina_support=retina_support,
                                        executable=executable,
                                        version=VERSION)

    create_file(destination_folder, 'Info.plist', filled_info_plist)

def create_file(destination_folder, file_name, data):
    with open(os.path.join(destination_folder, file_name), 'w') as f:
        f.write(data)

def create_binary(destination_folder, file_name, data):
    with open(os.path.join(destination_folder, file_name), 'wb') as f:
        f.write(bytearray.fromhex(data))

#------------------------------------------------------------------------------
# Convert a sequence of strings, separated by spaces, into a sequence of
# <string></string> strings.
# E.g., "a b c" becomes "<string>a</string>b<string></string><string>c</string>
#
# This is to be used for the JVMArguments and JVMOptions in the plist.xml file.
# Also note that there is some whitespace added. This is to comply with the
# indent of the xml file.
#------------------------------------------------------------------------------
def string_to_plist_xmlarray_values(s):
    if not s:
        return ''
    return  '        <string>' + '</string>\n        <string>'.join( [i.strip() for i in shlex.split(s) ] ) + '</string>'

#------------------------------------------------------------------------------
# Check if JDK/JRE is valid. It can be a zip file or it can be a directory.
# Returns:
#   * The xml string to use
#   * The JDK/JRE folder name (not its full path; e.g. for zip files, it strips
#     the zip extension)
#   * Whether the JDK/JRE is a file or a directory
#------------------------------------------------------------------------------
def determine_jdk(jdk):
    if not jdk:
        return '','',True
    isfile = os.path.isfile(jdk)
    if isfile:
        if not jdk.lower().endswith('.zip'):
            exit('JDK/JRE file is not a zip file.')
        jdk = strip_extension_from_name(os.path.basename(jdk))

    dir, name = os.path.split(jdk)
    return '<key>JVMRuntime</key>\n<string>' + name + '</string>',jdk,isfile

#------------------------------------------------------------------------------
# Copy a JDK to the bundled .app. The app_full_path should be the root of
# the app (e.g. Test.app/). JDK should be the path to the JDK/JRE and
# jdk_isfile comes from determine_jdk and indicates if the this JDK is a zip
# file or a directory.
#
# In case it's a directory, we just copy it over. If it's a zip file, we must
# first decompress it.
#
# In general, the JVM should go to <appname>.App/Contents/PlugIns, e.g. the
# structure might become
# <appname>.App/Contents/PlugIns/jdk1.8.0_40.jdk
#
# This JDK should be in the format expected by AppBundler (check if the first
# directory is just a Contents folder)
#------------------------------------------------------------------------------
def copy_jdk(app_full_path, jdk, jdk_isfile):
    if jdk:
        if jdk_isfile:
            tmpdir = tempfile.mkdtemp()
            f = ZipFile(jdk, 'r')
            f.extractall(tmpdir)
            jdk_dir = tmpdir
            try:
                destination_path = os.path.join(app_full_path, 'Contents', 'PlugIns')
                os.rmdir(destination_path)
                shutil.copytree(jdk_dir, destination_path)
            except FileExistsError as e:
                raise # FIXME
            try:
                base_path = os.path.join(app_full_path, 'Contents', 'PlugIns')
                dir = os.listdir(base_path)[0]
                final_dir = os.path.join(base_path, strip_extension_from_name(os.path.basename(jdk)))
                shutil.rmtree(final_dir, ignore_errors=True)  # Delete old folder (if it exists)
                os.rename(os.path.join(base_path, dir), final_dir)
                shutil.rmtree(tmpdir)
            except:
                raise #FIXME
        else:
            destination = os.path.join(app_full_path, 'Contents', 'PlugIns', os.path.basename(jdk))
            shutil.rmtree(destination, ignore_errors=True) # Delete old folder (if it exists)
            shutil.copytree(jdk, destination, symlinks=True)


# ------------------------------------------------------------------------------
# Copy all files while also preserving status information. If status cannot be
# copied, drop it and copy mode instead.
# ------------------------------------------------------------------------------
def copy_preserve_status(src, dst):
    try:
        shutil.copy2(src, dst)
    except OSError:
        shutil.copy(src, dst)

#------------------------------------------------------------------------------
# Copy all files to the previously created directory. This involes copying
# the Localizable.strings file, the JavaAppLauncher executable and, finally,
# the JDK/JRE and application icon if they were provided
#------------------------------------------------------------------------------
def copy_base_files(app_full_path, icon, jar_file, jdk, jdk_isfile, executable, executable_file):
    if icon:
        copy_preserve_status(icon,os.path.join(app_full_path, 'Contents', 'Resources'))
    create_file(os.path.join(app_full_path, 'Contents', 'Resources', 'en.lproj'), 'Localizable.strings', localizable_strings)
    if executable_file:
        copy_preserve_status(executable_file, os.path.join(app_full_path, 'Contents', 'MacOS', executable))
    else:
        create_binary(os.path.join(app_full_path, 'Contents', 'MacOS'), executable, java_app_launcher)
    make_executable(os.path.join(app_full_path, 'Contents', 'MacOS', executable))
    copy_preserve_status(jar_file, os.path.join(app_full_path, 'Contents', 'Java', os.path.basename(jar_file)))
    copy_jdk(app_full_path, jdk, jdk_isfile)

#------------------------------------------------------------------------------
# Determine the destination Appname (and full path) taking into account the
# parameters. Note that:
# 1. If output is provided and it is a destination file, its name is used as
#    the appname
# 2. If output is provided but it is a destination folder, then name must be
#    figured out with the next steps (as if output wasn't provided).
# 3. Prefer the bundle name
# 4. Prefer the bundle displayname
# 5. Prefer the jar name (without extension, of course)
# We also assume that by default the output should go to the current directory.
#------------------------------------------------------------------------------
def determine_app_name(jar_name, output, bundle_displayname, bundle_name, auto_append_app):
    if output:
        dir,name = os.path.split(output)
        if not dir: #All that was given was a filename
            dir = '.'
    else: #Assume default directory
        dir = '.'
        name = ''

    if not name:
        # If no .app name is provided, prefer:
        # 1. The bundle name, if it was provided
        # 2. the bundle_displayname, if it was provided
        # 3. The jar name
        if bundle_name:
            return os.path.join(dir,bundle_name + '.app')
        elif bundle_displayname:
            return os.path.join(dir,bundle_displayname + '.app')
        elif jar_name:
            return os.path.join(dir,strip_extension_from_name(jar_name) + '.app')
    else:
        # Ensure the name ends with .app, unless we were told not to do so
        if auto_append_app:
            if name.lower().endswith('.app'):
                return os.path.join(dir,name)
            else:
                return os.path.join(dir,name + '.app')
        else:
            return os.path.join(dir,name)

#------------------------------------------------------------------------------
# Print summary info on the fields used, if they are used. Used when the
# process is done
#------------------------------------------------------------------------------
def print_final_file_info(icon, bundle_identifier, bundle_displayname, bundle_name, short_version_string,
                          unique_signature, bundle_version, copyright_str, orig_jvm_options, main_class_name,
                          jdk, retina_support, use_screen_menu_bar, working_directory, executable):
    def print_field_if_not_null(name, field):
        if field:
            print('{}: {}'.format(name, field))

    print_field_if_not_null('CFBundleIconFile', icon)
    print_field_if_not_null('CFBundleIdentifier', bundle_identifier)
    print_field_if_not_null('CFBundleDisplayName', bundle_displayname)
    print_field_if_not_null('CFBundleName', bundle_name)
    print_field_if_not_null('CFBundleShortVersionString', short_version_string)
    print_field_if_not_null('CFBundleSignature', unique_signature)
    print_field_if_not_null('CFBundleVersion', bundle_version)
    print_field_if_not_null('NSHumanReadableCopyright', copyright_str)
    if retina_support:
        print('Retina support enabled.')

    if use_screen_menu_bar:
        print('macOS menubar support enabled (might not always work).')

    print('---')
    print_field_if_not_null('JVMOptions', orig_jvm_options)
    print_field_if_not_null('JVMMainClassName', main_class_name)
    print_field_if_not_null('JVMRuntime', jdk)
    print_field_if_not_null('Executable Name (CFBundleExecutable)', executable)
    print_field_if_not_null('JAR Working directory', working_directory)

#------------------------------------------------------------------------------
# This is the main application logic. It receives the arguments straight from
# the user, gives appropriate defaults, builds the directory structure,
# copies files (packing the JDK/JRE) and creates the plist file. In the end,
# if all went well, it displays summary info.
#------------------------------------------------------------------------------
def make_app(jar_file, output='.', icon=None, bundle_identifier=None, bundle_displayname=None, bundle_name=None,
             bundle_version=None, short_version_string=None, copyright_str=None, main_class_name=None,
             jvm_arguments=None, jvm_options=None, jdk=None, unique_signature=None, auto_append_app=True,
             retina_screen=True, use_screen_menu_bar=False, working_directory=None, executable=None,
             executable_file=None):
    def default_value(d, default):
        return d if d else default

    orig_jvm_options  = jvm_options
    if not jvm_options: jvm_options = ''
    jar_name          = os.path.basename(jar_file)
    app_full_path     = determine_app_name(jar_name, output, bundle_displayname, bundle_name, auto_append_app)
    app_name          = strip_extension_from_name(os.path.basename(app_full_path))
    icon              = default_value(icon, '')
    bundle_identifier = default_value(bundle_identifier, DEFAULT_BUNDLE_IDENTIFIER_PREFIX + app_name)

    if jdk:
        # Remove any trailing forward and backslashes which might screw up os.path.basename when copying the JDK.
        jdk = jdk.rstrip('/').rstrip('\\')

    if use_screen_menu_bar:
        jvm_options += ' -Dapple.laf.useScreenMenuBar=true'

    if working_directory:
        jvm_options += ' -Duser.dir="%s"' % working_directory

    if not bundle_displayname:
        # If no bundle_displayname is provided:
        # 1. Use the bundle_name
        # 2. use the app_name (note that the app_name was already determined based on what the user gave us.
        #    For instance, if no app_name was given, and no displayname was given, and no app name was given, the
        #    first choice is the bundle_name.
        if bundle_name:
            bundle_displayname = bundle_name
        else:
            bundle_displayname = app_name

	# Set the app name in the macOS menu bar (About and Quit menu items)
    jvm_options += ' -Xdock:name="%s"' % bundle_displayname

    # When we get here, we always have a displayname. So if there's no bundlename, go with that. It may itself have
    # come from the app name
    bundle_name = default_value(bundle_name, bundle_displayname)

    if not bundle_version:
            bundle_version = short_version_string if short_version_string else DEFAULT_VERSION

    # When we get here, we always have bundle_version, even if it is the default
    short_version_string        = default_value(short_version_string, bundle_version)
    copyright_str               = default_value(copyright_str, '')
    main_class_name             = default_value(main_class_name, find_jar_mainclass(jar_file))
    unique_signature            = default_value(unique_signature, '????')
    jvm_arguments               = string_to_plist_xmlarray_values(jvm_arguments)
    jvm_options                 = string_to_plist_xmlarray_values(jvm_options)
    jdk_xml,jdk_name,jdk_isfile = determine_jdk(jdk)

    if retina_screen:
        retina_screen = retina_support_string
    else:
        retina_screen = ''

    print('Packing {} into {}'.format(jar_file, os.path.abspath(app_full_path)))

    build_directory_structure(app_full_path)
    create_plist_file(os.path.join(app_full_path, 'Contents'), os.path.basename(icon), bundle_identifier,
                      bundle_displayname, bundle_name,bundle_version,short_version_string,copyright_str,
                      main_class_name, jvm_arguments, jvm_options, jdk_xml, unique_signature, retina_screen, executable)
    copy_base_files(app_full_path, icon, jar_file, jdk, jdk_isfile, executable, executable_file)

    print_final_file_info(icon, bundle_identifier, bundle_displayname, bundle_name, short_version_string,
                          unique_signature, bundle_version, copyright_str, orig_jvm_options, main_class_name,
                          jdk_name, retina_screen, use_screen_menu_bar, working_directory, executable)

    print("\n{} packaged to {}.".format(jar_file, os.path.abspath(app_full_path)))

def parse_input():
    parser = OptionParser()
    parser.add_option('-n', '--name', help='Package/Bundle name.', dest='bundle_name', type='string', default=None)
    parser.add_option('-d', '--display-name', help='Package/Bundle display name.', dest='bundle_displayname', type='string',default=None)
    parser.add_option('-i', '--icon',help='Icon (in .icns format). (Default: None)', dest='icon', type='string', default=None)
    parser.add_option('-b', '--bundle-identifier', help='Package/Bundle identifier (e.g. com.example.test) (Default is application name prefix by {}.'.format(DEFAULT_BUNDLE_IDENTIFIER_PREFIX), dest='bundle_identifier',type='string', default=None)
    parser.add_option('-v', '--version', help='Package/Bundle version (e.g. 1.0.0) (Default: {}).'.format(DEFAULT_VERSION),dest='bundle_version', type='string', default=DEFAULT_VERSION)
    parser.add_option('-s', '--short-version', help='Package/Bundle short version (see Apple\'s documentation on CFBundleShortVersionString) (Default: {}).'.format(DEFAULT_VERSION), dest='short_version_string',type='string', default=DEFAULT_VERSION)
    parser.add_option('-c', '--copyright',help='Package/Bundle copyright string (e.g. (c) 2015 Awesome Person) (Default: empty)',dest='copyright_str', type='string', default=None)
    parser.add_option('-u', '--unique-signature', help='4 Byte unique signature of your application (Default: {})'.format(DEFAULT_SIGNATURE),dest='signature', type='string', default=DEFAULT_SIGNATURE)
    parser.add_option('-m', '--main-class', help='Jar main class. Blank for auto-detection (usually right).',dest='main_class_name', type='string', default=None)
    parser.add_option('-r', '--runtime', help='JRE/JDK runtime to bundle. Can be a folder or a zip file. If none is given, the default on the system is used (default: None)',dest='jdk', type='string', default=None)
    parser.add_option('-j', '--jvm-options',help='Extra JVM options. Place one by one, separated by spaces, inside single quotes (e.g. -o \'-Xmx1024M -Xms256M\'). (Default: None)',dest='jvm_options', type='string', default=None)
    parser.add_option('-a', '--no-append-app-to-name', help='Do not try to append .app to the output file by default.', dest='auto_append_name', action='store_false')
    parser.add_option('-l', '--low-res-mode', help='Do not try to report retina-screen capabilities (use low resolution mode; by default high resolution mode is used).',dest='retina_screen', action='store_false')
    parser.add_option('-o', '--use-osx-menubar', help='Use OSX menu bar instead of Java menu bar (Default: False).', dest='use_screen_menu_bar', action='store_true')
    parser.add_option('-x', '--executable-file', help='Internal executable to launch. By default, JavaAppLauncher provided by jar2app is used.', dest='executable_file', type='string', default=None)
    parser.add_option('-e', '--executable-name', help='Name of the internal executable to launch (Default: %s).' % DEFAULT_EXECUTABLE_NAME,
                      dest='executable', default='JavaAppLauncher')
    parser.add_option('-w','--working-directory', help='Set current working directory (user.dir) on launch (Default: $APP_ROOT/Contents).', dest='working_directory', type='string', default='$APP_ROOT/Contents')

    (options, args) = parser.parse_args()

    if len(args) == 2:
        input_file = args[0]
        output = args[1]
    elif len(args) > 2:
        parser.error('Extra arguments provided!')
    elif len(args) == 1:
        input_file = args[0]
        output = None
    else:
        parser.error('An input file is needed. Optionally, you can also provide an output file or directory. E.g.\n{} in.jar\n{} in.jar out.app\n{} in.jar out/'.format(sys.argv[0], sys.argv[0], sys.argv[0]) )

    if options.auto_append_name == None:
        options.auto_append_name = True

    if options.retina_screen == None:
        options.retina_screen = True

    jvm_arguments = ''

    return input_file, output, options.icon, options.bundle_identifier, options.bundle_displayname, options.bundle_name,\
           options.bundle_version, options.short_version_string, options.copyright_str, options.main_class_name,\
           jvm_arguments, options.jvm_options, options.jdk, options.signature, options.auto_append_name,\
           options.retina_screen, options.use_screen_menu_bar, options.working_directory, options.executable,\
           options.executable_file

def main():
    print('jar2app %s, João Ricardo Lourenço, 2015-2017 <jorl17.8@gmail.com>.' % VERSION)
    print('Github page: https://github.com/Jorl17/jar2app/')
    make_app(*parse_input())

main()
